{"version":3,"sources":["../../../../src/plugins/proxy/__tests__/index.js"],"names":["servers","require","chai","use","chaiString","sh","config","silent","timeout","serverInfo","mymeteor","cd","path","resolve","os","tmpdir","out","exec","code","to","equal","output","have","entriesCount"],"mappings":"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","file":"index.js","sourcesContent":["import chai, { expect } from 'chai';\nimport { describe, it } from 'mocha';\nimport chaiString from 'chai-string';\nimport os from 'os';\nimport path from 'path';\nimport { runSSHCommand } from '../../../utils';\nimport sh from 'shelljs';\nconst servers = require('../../../../tests/fixtures/servers');\n\nchai.use(chaiString);\n\nsh.config.silent = false;\n\ndescribe('module - proxy', function() {\n  this.timeout(60000000);\n\n  describe('setup', () => {\n    it('should setup proxy on \"meteor\" vm', async () => {\n      const serverInfo = servers.mymeteor;\n      sh.cd(path.resolve(os.tmpdir(), 'tests/project-3'));\n      let out = sh.exec('mup setup');\n\n      expect(out.code).to.equal(0);\n      expect(out.output).to.have.entriesCount('Setup proxy', 1);\n      expect(out.output).to.have.entriesCount('Start proxy: SUCCESS', 1);\n\n      out = await runSSHCommand(serverInfo, 'docker ps');\n\n      expect(out.code).to.equal(0);\n      expect(out.output).to.have.entriesCount('mup-nginx-proxy', 2);\n      expect(out.output).to.have.entriesCount('mup-nginx-proxy-letsencrypt', 1);\n\n      out = await runSSHCommand(serverInfo, 'du --max-depth=2 /opt');\n      expect(out.output).to.have.entriesCount('/opt/mup-nginx-proxy', 4);\n      expect(out.output).to.have.entriesCount('/opt/mup-nginx-proxy/certs', 1);\n      expect(out.output).to.have.entriesCount('/opt/mup-nginx-proxy/mounted-certs', 1);\n      expect(out.output).to.have.entriesCount('/opt/mup-nginx-proxy/config', 1);\n\n      out = await runSSHCommand(serverInfo, 'ls /opt/mup-nginx-proxy/config');\n      expect(out.output).to.have.entriesCount('shared-config.sh', 1);\n      expect(out.output).to.have.entriesCount('env.list', 1);\n      expect(out.output).to.have.entriesCount('env_letsencrypt.list', 1);\n    });\n  });\n\n  describe('reconfig-shared', () => {\n    it('it should update shared settings', async () => {\n      const serverInfo = servers.mymeteor;\n      sh.cd(path.resolve(os.tmpdir(), 'tests/project-3'));\n      sh.exec('mup setup');\n\n      let out = sh.exec('mup proxy reconfig-shared');\n      expect(out.code).to.equal(0);\n      expect(out.output).to.have.entriesCount('Configuring Proxy\\'s Shared Settings', 1);\n      expect(out.output).to.have.entriesCount('Start proxy: SUCCESS', 1);\n\n      out = await runSSHCommand(serverInfo, 'cat /opt/mup-nginx-proxy/config/shared-config.sh');\n      expect(out.output).to.have.entriesCount('CLIENT_UPLOAD_LIMIT=10M', 1);\n    });\n  });\n\n  describe('logs', () => {\n    it('should show nginx logs', () => {\n      sh.cd(path.resolve(os.tmpdir(), 'tests/project-3'));\n      sh.exec('mup setup');\n\n      const out = sh.exec('mup proxy logs --tail 2');\n      expect(out.output).to.have.entriesCount('Received event start for', 1);\n      expect(out.code).to.equal(0);\n    });\n  });\n});\n"]}